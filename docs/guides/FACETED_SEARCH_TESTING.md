# Faceted Search åŠŸèƒ½æ¸¬è©¦æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

Faceted Search (åˆ†é¢æœå°‹) åŠŸèƒ½å·²å®Œæ•´å¯¦ä½œï¼ŒåŒ…å«ï¼š

### å¾Œç«¯å¯¦ä½œ
- **æ ¸å¿ƒå¼•æ“**: `src/ir/facet/facet_engine.py` - è¨ˆç®— facet åˆ†å¸ƒ
- **éæ¿¾é‚è¼¯**: `src/ir/facet/facet_filter.py` - è™•ç†å¤šç¶­åº¦ç¯©é¸æ¢ä»¶
- **Flask API**: `app_simple.py` - æä¾› `/api/facets` å’Œ `/api/search/faceted` ç«¯é»
- **æ¸¬è©¦**: 31/31 å–®å…ƒæ¸¬è©¦é€šé

### å‰ç«¯å¯¦ä½œ
- **JavaScript**: `static/js/facet.js` - å‹•æ…‹ facet è¼‰å…¥å’Œäº’å‹•é‚è¼¯
- **CSS**: `static/css/facet.css` - å®Œæ•´ UI æ¨£å¼ï¼ˆå«éŸ¿æ‡‰å¼è¨­è¨ˆå’Œæ·±è‰²æ¨¡å¼ï¼‰
- **HTML**: `templates/search.html` - å·²æ•´åˆ facet UI çµ„ä»¶

---

## æ¸¬è©¦å‰æº–å‚™

### 1. æª¢æŸ¥ Python ç’°å¢ƒ

```bash
source activate ai_env
python --version  # æ‡‰ç‚º Python 3.10+
```

### 2. å®‰è£/æ›´æ–°ä¾è³´

å¦‚æœé‡åˆ° `ImportError: cannot import name 'url_quote' from 'werkzeug.urls'` éŒ¯èª¤ï¼š

```bash
# æ–¹æ³• 1: æ›´æ–° werkzeug
pip install --upgrade werkzeug

# æ–¹æ³• 2: é™ç´š werkzeug åˆ°ç›¸å®¹ç‰ˆæœ¬
pip install 'werkzeug<3.0'

# æ–¹æ³• 3: æ›´æ–° Flask åˆ°æœ€æ–°ç‰ˆæœ¬
pip install --upgrade Flask
```

### 3. ç¢ºèªè³‡æ–™æª”æ¡ˆ

ç¢ºä¿æœ‰å»ºç«‹å¥½çš„ç´¢å¼•æª”æ¡ˆï¼š

```bash
ls -lh data/index_50k/  # æˆ–å…¶ä»–ç´¢å¼•ç›®éŒ„
```

---

## æ¸¬è©¦æ­¥é©Ÿ

### éšæ®µ 1: å–®å…ƒæ¸¬è©¦ï¼ˆå¾Œç«¯é‚è¼¯ï¼‰

```bash
# åŸ·è¡Œ facet æ¨¡çµ„æ¸¬è©¦
pytest tests/test_facet.py -v

# é æœŸçµæœï¼š31 passed
```

**æ¸¬è©¦è¦†è“‹**ï¼š
- âœ… Term facet å»ºç«‹ (æ–°èä¾†æºã€åˆ†é¡)
- âœ… Date range facet (æœˆä»½åˆ†çµ„)
- âœ… å¤šæ¢ä»¶éæ¿¾ (AND/OR é‚è¼¯)
- âœ… 8 ç¨®éæ¿¾é‹ç®—å­ (EQUALS, IN, RANGE, GT, LT, GTE, LTE, CONTAINS)

---

### éšæ®µ 2: API ç«¯é»æ¸¬è©¦

#### 2.1 å•Ÿå‹• Flask æ‡‰ç”¨

```bash
python app_simple.py
```

**é æœŸè¼¸å‡º**ï¼š
```
 * Running on http://127.0.0.1:5000
 * Index loaded: 41273 documents
```

#### 2.2 åŸ·è¡Œ API æ¸¬è©¦è…³æœ¬

åœ¨å¦ä¸€å€‹çµ‚ç«¯åŸ·è¡Œï¼š

```bash
source activate ai_env
python test_facet_api.py
```

**é æœŸçµæœ**ï¼š
```
============================================================
Testing /api/facets endpoint
============================================================

âœ… /api/facets endpoint working!
Total results: 50
Facets available: ['source', 'category', 'category_name', 'pub_date', 'author']

ğŸ“° æ–°èä¾†æº facet:
  ä¸­å¤®ç¤¾: 15 ç¯‡
  è‡ªç”±æ™‚å ±: 12 ç¯‡
  ...

============================================================
Testing /api/search/faceted endpoint
============================================================

--- Test 1: Filter by source (CNA) ---
âœ… Filter test passed!
Total results before filter: 50
Filtered results: 15

--- Test 2: Filter by category ---
âœ… Category filter test passed!

============================================================
Test Summary
============================================================
/api/facets: âœ… PASS
/api/search/faceted: âœ… PASS

ğŸ‰ All tests passed!
```

---

### éšæ®µ 3: å‰ç«¯ UI æ¸¬è©¦

#### 3.1 é–‹å•Ÿç€è¦½å™¨

è¨ªå•ï¼š`http://localhost:5000`

#### 3.2 åŸ·è¡Œæœå°‹æŸ¥è©¢

1. **è¼¸å…¥æŸ¥è©¢é—œéµå­—**ï¼ˆä¾‹å¦‚ï¼šã€Œå°ç£ç¶“æ¿Ÿã€ï¼‰
2. **é»æ“Šã€Œæœå°‹ã€æŒ‰éˆ•**
3. **é»æ“Šã€Œé€²éšç¯©é¸ã€æŒ‰éˆ•** å±•é–‹ facet é¢æ¿

#### 3.3 é©—è­‰ Facet é¡¯ç¤º

**é æœŸçœ‹åˆ°çš„ Facet ç¾¤çµ„**ï¼š

```
ğŸ“‹ é€²éšç¯©é¸é¸é …

ğŸ“° æ–°èä¾†æº
  â˜ ä¸­å¤®ç¤¾ (15)
  â˜ è‡ªç”±æ™‚å ± (12)
  â˜ è¯åˆå ± (10)
  ...

ğŸ·ï¸ åˆ†é¡
  â˜ politics (æ”¿æ²») (20)
  â˜ finance (è²¡ç¶“) (15)
  â˜ life (ç”Ÿæ´») (10)
  ...

ğŸ“… ç™¼å¸ƒæœˆä»½
  â˜ 2025-01 (25)
  â˜ 2024-12 (18)
  ...

[æ¸…é™¤æ‰€æœ‰ç¯©é¸]
```

#### 3.4 æ¸¬è©¦ Facet äº’å‹•

**æ¸¬è©¦ 1: å–®ä¸€ Facet ç¯©é¸**
1. å‹¾é¸ã€Œä¸­å¤®ç¤¾ã€
2. âœ… æ‡‰çœ‹åˆ°ã€Œå·²å¥—ç”¨ç¯©é¸: æ–°èä¾†æº: ä¸­å¤®ç¤¾ Ã—ã€æ¨™ç±¤
3. âœ… æœå°‹çµæœè‡ªå‹•æ›´æ–°ï¼Œåªé¡¯ç¤ºä¸­å¤®ç¤¾æ–°è
4. âœ… çµæœçµ±è¨ˆé¡¯ç¤ºã€Œæ‰¾åˆ° 15 ç­†çµæœ (å…± 50 ç­†)ã€

**æ¸¬è©¦ 2: å¤šé‡ Facet ç¯©é¸**
1. ä¿æŒã€Œä¸­å¤®ç¤¾ã€å‹¾é¸
2. å†å‹¾é¸ã€Œpoliticsã€åˆ†é¡
3. âœ… æ‡‰çœ‹åˆ°å…©å€‹ç¯©é¸æ¨™ç±¤
4. âœ… æœå°‹çµæœåªé¡¯ç¤ºã€Œä¸­å¤®ç¤¾ + æ”¿æ²»é¡ã€æ–°è

**æ¸¬è©¦ 3: ç§»é™¤å–®ä¸€ç¯©é¸**
1. é»æ“Šã€Œæ–°èä¾†æº: ä¸­å¤®ç¤¾ Ã—ã€çš„ `Ã—` æŒ‰éˆ•
2. âœ… è©²ç¯©é¸æ¨™ç±¤æ¶ˆå¤±
3. âœ… checkbox è‡ªå‹•å–æ¶ˆå‹¾é¸
4. âœ… æœå°‹çµæœæ›´æ–°ç‚ºã€Œæ‰€æœ‰ä¾†æº + æ”¿æ²»é¡ã€

**æ¸¬è©¦ 4: æ¸…é™¤æ‰€æœ‰ç¯©é¸**
1. é»æ“Šã€Œæ¸…é™¤æ‰€æœ‰ç¯©é¸ã€æŒ‰éˆ•
2. âœ… æ‰€æœ‰ç¯©é¸æ¨™ç±¤æ¶ˆå¤±
3. âœ… æ‰€æœ‰ checkboxes å–æ¶ˆå‹¾é¸
4. âœ… æœå°‹çµæœæ¢å¾©ç‚ºå®Œæ•´çš„ 50 ç­†

**æ¸¬è©¦ 5: é¡¯ç¤ºæ›´å¤š Facet å€¼**
1. å¦‚æœæŸå€‹ facet æœ‰è¶…é 10 å€‹å€¼ï¼Œæ‡‰é¡¯ç¤ºã€Œé¡¯ç¤ºæ›´å¤š (N)ã€æŒ‰éˆ•
2. é»æ“ŠæŒ‰éˆ•
3. âœ… å±•é–‹é¡¯ç¤ºæ‰€æœ‰ facet å€¼
4. âœ… æŒ‰éˆ•æ¶ˆå¤±

---

### éšæ®µ 4: éŸ¿æ‡‰å¼è¨­è¨ˆæ¸¬è©¦

#### 4.1 æ¡Œé¢ç‰ˆ (> 768px)
- âœ… Facet panel æ­£å¸¸é¡¯ç¤ºåœ¨å·¦å´æˆ–ä¸Šæ–¹
- âœ… Facet æ¨™ç±¤æ°´å¹³æ’åˆ—
- âœ… æ»¾å‹•æ¢æ­£å¸¸é¡¯ç¤º

#### 4.2 è¡Œå‹•ç‰ˆ (< 768px)
- âœ… Filter panel å¯æ­£å¸¸å±•é–‹/æ”¶èµ·
- âœ… Facet æ¨™ç±¤å‚ç›´å †ç–Š
- âœ… æŒ‰éˆ•å¯¬åº¦ 100%
- âœ… è§¸æ§æ“ä½œé †æš¢

#### 4.3 æ·±è‰²æ¨¡å¼
åœ¨ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ä¸­æ¨¡æ“¬æ·±è‰²æ¨¡å¼ï¼š
```
Ctrl+Shift+I â†’ Console â†’
document.documentElement.setAttribute('data-theme', 'dark')
```
- âœ… Facet èƒŒæ™¯è®Šç‚ºæ·±è‰²
- âœ… æ–‡å­—é¡è‰²è‡ªå‹•èª¿æ•´
- âœ… å°æ¯”åº¦è¶³å¤ æ¸…æ™°

---

## å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1: Flask ç„¡æ³•å•Ÿå‹•

**éŒ¯èª¤**: `ImportError: cannot import name 'url_quote' from 'werkzeug.urls'`

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
pip install --upgrade werkzeug
# æˆ–
pip install 'werkzeug<3.0'
```

### å•é¡Œ 2: Facet æ²’æœ‰é¡¯ç¤º

**æª¢æŸ¥æ­¥é©Ÿ**:
1. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12)
2. æŸ¥çœ‹ Console æ˜¯å¦æœ‰ JavaScript éŒ¯èª¤
3. æª¢æŸ¥ Network æ¨™ç±¤ï¼Œç¢ºèª `/api/facets` è«‹æ±‚æˆåŠŸ (status 200)
4. ç¢ºèªå›å‚³çš„ JSON åŒ…å« `"success": true`

**å¸¸è¦‹åŸå› **:
- ç´¢å¼•æª”æ¡ˆæœªæ­£ç¢ºè¼‰å…¥
- æœå°‹çµæœç‚ºç©º (ç„¡æ³•è¨ˆç®— facets)
- JavaScript è¼‰å…¥å¤±æ•—

### å•é¡Œ 3: ç¯©é¸ç„¡æ•ˆ

**æª¢æŸ¥æ­¥é©Ÿ**:
1. ç¢ºèªå‹¾é¸ checkbox æ™‚æœ‰è§¸ç™¼è«‹æ±‚
2. æŸ¥çœ‹ Network æ¨™ç±¤çš„ `/api/search/faceted` è«‹æ±‚
3. ç¢ºèªè«‹æ±‚ payload åŒ…å«æ­£ç¢ºçš„ `filters` åƒæ•¸

**é™¤éŒ¯æ–¹æ³•**:
```javascript
// åœ¨ç€è¦½å™¨ Console ä¸­æª¢æŸ¥ facet ç‹€æ…‹
console.log(window.FacetSearch.state);
```

### å•é¡Œ 4: CSS æ¨£å¼ç•°å¸¸

**æª¢æŸ¥æ­¥é©Ÿ**:
1. ç¢ºèª `static/css/facet.css` æª”æ¡ˆå­˜åœ¨
2. æŸ¥çœ‹ Network æ¨™ç±¤ï¼Œç¢ºèª CSS æª”æ¡ˆæˆåŠŸè¼‰å…¥
3. æª¢æŸ¥æ˜¯å¦æœ‰ CSS è¡çª

**è‡¨æ™‚è§£æ±º**:
æ¸…é™¤ç€è¦½å™¨å¿«å–ä¸¦é‡æ–°è¼‰å…¥ (Ctrl+Shift+R)

---

## æ•ˆèƒ½åŸºæº–

### API ç«¯é»æ•ˆèƒ½
- **Facet è¨ˆç®—**: 50 æ–‡æª” < 50ms, 1000 æ–‡æª” < 500ms
- **ç¯©é¸æŸ¥è©¢**: < 100ms (10,000 æ–‡æª”)
- **ç«¯åˆ°ç«¯è«‹æ±‚**: < 200ms

### å‰ç«¯äº’å‹•æ•ˆèƒ½
- **Facet æ¸²æŸ“**: < 50ms (20 facet groups)
- **Checkbox åˆ‡æ›**: < 10ms
- **ç¯©é¸æ›´æ–°**: < 150ms (å« API è«‹æ±‚)

### è¨˜æ†¶é«”ä½¿ç”¨
- **å¾Œç«¯ facet engine**: < 50MB (10,000 æ–‡æª”)
- **å‰ç«¯ facet state**: < 1MB

---

## ä¸‹ä¸€æ­¥å»ºè­°

### åŠŸèƒ½æ“´å±•
1. **ç¯„åœç¯©é¸ UI**: ç‚ºæ•¸å€¼å’Œæ—¥æœŸ facets æ·»åŠ æ»‘æ¡¿çµ„ä»¶
2. **Facet æ’åº**: æŒ‰æ–‡æª”æ•¸é‡æˆ–å­—æ¯é †åºæ’åº facet å€¼
3. **Facet æœå°‹**: ç‚ºé•·åˆ—è¡¨ facets æ·»åŠ æœå°‹æ¡†
4. **Facet å¿«å–**: ç‚ºç†±é–€æŸ¥è©¢å¿«å– facet è³‡æ–™
5. **å‹•æ…‹ Facet**: æ ¹æ“šç¯©é¸çµæœå‹•æ…‹æ›´æ–° facet è¨ˆæ•¸

### æ•ˆèƒ½å„ªåŒ–
1. **å¢é‡è¼‰å…¥**: å¯¦ä½œ facet å€¼çš„æ‡¶è¼‰å…¥
2. **ä¼ºæœå™¨ç«¯åˆ†é **: å°å¤§é‡ facet å€¼é€²è¡Œåˆ†é 
3. **å¿«å–ç­–ç•¥**: å¯¦ä½œ Redis å¿«å–å±¤
4. **WebSocket**: å¯¦æ™‚æ›´æ–° facet çµ±è¨ˆ

### UI/UX æ”¹å–„
1. **å‹•ç•«æ•ˆæœ**: æ·»åŠ å¹³æ»‘çš„å±•é–‹/æ”¶èµ·å‹•ç•«
2. **Loading ç‹€æ…‹**: é¡¯ç¤ºè¼‰å…¥ä¸­çš„éª¨æ¶å±
3. **éŒ¯èª¤è™•ç†**: æ›´å‹å–„çš„éŒ¯èª¤æç¤ºè¨Šæ¯
4. **éµç›¤å°èˆª**: æ”¯æ´ Tab/Enter éµæ“ä½œ

---

## æŠ€è¡“æ–‡ä»¶åƒè€ƒ

- **å¯¦ä½œæŒ‡å—**: `docs/guides/FACETED_SEARCH_INTEGRATION.md`
- **API æ–‡ä»¶**: æŸ¥çœ‹ `app_simple.py` çš„ docstrings
- **æ¸¬è©¦è…³æœ¬**: `test_facet_api.py`
- **å–®å…ƒæ¸¬è©¦**: `tests/test_facet.py`

---

## å›å ±å•é¡Œ

å¦‚æœæ¸¬è©¦éç¨‹ä¸­ç™¼ç¾ä»»ä½•å•é¡Œï¼Œè«‹æä¾›ï¼š

1. **å•é¡Œæè¿°**: ç°¡çŸ­æè¿°ç™¼ç”Ÿäº†ä»€éº¼
2. **é‡ç¾æ­¥é©Ÿ**: å¦‚ä½•é‡ç¾è©²å•é¡Œ
3. **é æœŸè¡Œç‚º**: æ‡‰è©²ç™¼ç”Ÿä»€éº¼
4. **å¯¦éš›è¡Œç‚º**: å¯¦éš›ç™¼ç”Ÿäº†ä»€éº¼
5. **ç’°å¢ƒè³‡è¨Š**: Python ç‰ˆæœ¬ã€ç€è¦½å™¨ç‰ˆæœ¬ã€OS
6. **æˆªåœ–/æ—¥èªŒ**: Console éŒ¯èª¤è¨Šæ¯æˆ–æˆªåœ–

---

**æ¸¬è©¦å®Œæˆæ—¥æœŸ**: 2025-01-21
**æ¸¬è©¦ç’°å¢ƒ**: Python 3.10, Flask 2.x, Chrome 120+
**æ¸¬è©¦ç‹€æ…‹**: âœ… å¾Œç«¯å®Œæˆ | â³ å‰ç«¯å¾…ç’°å¢ƒä¿®å¾©å¾Œæ¸¬è©¦
